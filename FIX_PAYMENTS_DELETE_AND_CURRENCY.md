# ุฑุจุท ุงููุฏููุนุงุช ูุงูููุจูุถุงุช ุจุงูุญุณุงุจ ุงูุจููู
# Link Payments/Receipts to Bank Account

## ๐ฏ ุงููุทููุจ | Requirements

1. โ ุฑุจุท ุงููุฏููุนุงุช ูุงูููุจูุถุงุช ุจุงูุญุณุงุจ ุงูุจููู
2. โ ุนูุฏ ุนูู ูุฏููุนุงุช: ูููุต ูู ุฑุตูุฏ ุงูุจูู
3. โ ุนูุฏ ุนูู ููุจูุถุงุช: ูุฒูุฏ ุฑุตูุฏ ุงูุจูู
4. โ ุนูุฏ ุญุฐู ูุฏููุนุงุช: ูุฒูุฏ ุฑุตูุฏ ุงูุจูู (ุนูุณ)
5. โ ุนูุฏ ุญุฐู ููุจูุถุงุช: ูููุต ูู ุฑุตูุฏ ุงูุจูู (ุนูุณ)
6. โ ุชูุนูู ุฒุฑ ุงูุญุฐู ูู ุตูุญุฉ ุงููุฏููุนุงุช
7. โ ุชุบููุฑ ุงูุนููุฉ ูู "ุฑูุงู" ุฅูู "โฌ" (ููุฑู)

---

## โ ุงูุชุบููุฑุงุช ุงูููุฌุฒุฉ | Changes Made

### **1. ุฑุจุท ุงููุฏููุนุงุช ุจุงูุญุณุงุจ ุงูุจููู ุนูุฏ ุงูุฅูุดุงุก**

**ุงูููู:** `app/accounting/routes.py` - ุงูุณุทูุฑ 328-357

ุชู ุฅุถุงูุฉ ููุฏ ูุชุญุฏูุซ ุฑุตูุฏ ุงูุจูู ุนูุฏ ุฅูุดุงุก ูุฏููุนุฉ/ููุจูุถุฉ:

```python
# Update bank account balance if bank payment method
if payment.bank_account_id and payment.payment_method in ['bank', 'check', 'card']:
    try:
        # Determine transaction type based on payment type
        if payment.payment_type == 'receipt':
            # Receipt: deposit money into bank (increase balance)
            transaction_type = 'deposit'
            description = f'ููุจูุถุงุช - {payment.payment_number}'
        else:
            # Payment: withdraw money from bank (decrease balance)
            transaction_type = 'withdrawal'
            description = f'ูุฏููุนุงุช - {payment.payment_number}'

        # Create bank transaction
        bank_transaction = create_bank_transaction(
            bank_account_id=payment.bank_account_id,
            transaction_type=transaction_type,
            amount=payment.amount,
            reference_type='payment',
            reference_id=payment.id,
            description=description
        )
```

**ุขููุฉ ุงูุนูู:**

**ููููุจูุถุงุช (Receipt):**
```python
# ููุน ุงููุนุงููุฉ: deposit (ุฅูุฏุงุน)
# ุฑุตูุฏ ุงูุจูู = ุฑุตูุฏ ุงูุจูู + ุงููุจูุบ
transaction_type = 'deposit'
```

**ูููุฏููุนุงุช (Payment):**
```python
# ููุน ุงููุนุงููุฉ: withdrawal (ุณุญุจ)
# ุฑุตูุฏ ุงูุจูู = ุฑุตูุฏ ุงูุจูู - ุงููุจูุบ
transaction_type = 'withdrawal'
```

---

### **2. ุนูุณ ุงููุนุงููุฉ ุงูุจูููุฉ ุนูุฏ ุงูุญุฐู**

**ุงูููู:** `app/accounting/routes.py` - ุงูุณุทูุฑ 411-449

ุชู ุฅุถุงูุฉ route ูุญุฐู ุงููุฏููุนุงุช ูุน ุนูุณ ุงููุนุงููุฉ ุงูุจูููุฉ:

```python
@bp.route('/payments/<int:id>/delete', methods=['POST'])
@login_required
@permission_required('accounting.payments.delete')
def delete_payment(id):
    """Delete payment - ุญุฐู ูุฏููุนุฉ"""
```

**ุขููุฉ ุนูุณ ุงููุนุงููุฉ:**

**ููููุจูุถุงุช (Receipt):**
```python
# ุนูุฏ ุงูุฅูุดุงุก: ุฑุตูุฏ ุงูุจูู + ุงููุจูุบ
# ุนูุฏ ุงูุญุฐู: ุฑุตูุฏ ุงูุจูู - ุงููุจูุบ (ุนูุณ)
if payment.payment_type == 'receipt':
    bank_account.current_balance -= payment.amount
```

**ูููุฏููุนุงุช (Payment):**
```python
# ุนูุฏ ุงูุฅูุดุงุก: ุฑุตูุฏ ุงูุจูู - ุงููุจูุบ
# ุนูุฏ ุงูุญุฐู: ุฑุตูุฏ ุงูุจูู + ุงููุจูุบ (ุนูุณ)
else:
    bank_account.current_balance += payment.amount
```

---

### **2. ุฅุถุงูุฉ ุฒุฑ ุงูุญุฐู ูู ุตูุญุฉ ุงููุงุฆูุฉ**

**ุงูููู:** `app/templates/accounting/payments.html` - ุงูุณุทูุฑ 101-110

ุชู ุฅุถุงูุฉ ุฒุฑ ุญุฐู ุฃุญูุฑ ุจุฌุงูุจ ุฒุฑ ุงูุชูุงุตูู:

```html
<button onclick="deletePayment({{ payment.id }}, '{{ payment.payment_number }}')" 
        class="btn btn-sm btn-danger" title="ุญุฐู">
    <i class="fas fa-trash"></i>
</button>
```

---

### **3. ุฅุถุงูุฉ JavaScript ููุชุฃููุฏ**

**ุงูููู:** `app/templates/accounting/payments.html` - ุงูุณุทูุฑ 161-175

ุชู ุฅุถุงูุฉ ุฏุงูุฉ JavaScript ูุชุฃููุฏ ุงูุญุฐู:

```javascript
function deletePayment(paymentId, paymentNumber) {
    if (confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงููุฏููุนุฉ ${paymentNumber}ุ\n\nููุงุญุธุฉ: ุณูุชู ุนูุณ ุงููุนุงููุฉ ุงูุจูููุฉ ุฅุฐุง ูุงูุช ููุฌูุฏุฉ.`)) {
        // Create form and submit
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/accounting/payments/${paymentId}/delete`;
        document.body.appendChild(form);
        form.submit();
    }
}
```

---

### **4. ุชุบููุฑ ุงูุนููุฉ ุฅูู ุงูููุฑู**

#### **ุฃ. ุตูุญุฉ ูุงุฆูุฉ ุงููุฏููุนุงุช**
**ุงูููู:** `app/templates/accounting/payments.html` - ุงูุณุทุฑ 78

```html
<!-- ูุจู -->
{{ "{:,.2f}".format(payment.amount) }} ุฑูุงู

<!-- ุจุนุฏ -->
{{ "{:,.2f}".format(payment.amount) }} โฌ
```

#### **ุจ. ุตูุญุฉ ุชูุงุตูู ุงููุฏููุนุฉ**
**ุงูููู:** `app/templates/accounting/payment_details.html` - ุงูุณุทุฑ 40

```html
<!-- ูุจู -->
{{ "{:,.2f}".format(payment.amount) }} ุฑูุงู

<!-- ุจุนุฏ -->
{{ "{:,.2f}".format(payment.amount) }} โฌ
```

---

## ๐ ููุฎุต ุงููููุงุช ุงููุนุฏูุฉ | Modified Files

| ุงูููู | ุงูุชุบููุฑ | ุงูุณุทูุฑ |
|-------|---------|--------|
| **app/accounting/routes.py** | ุฅุถุงูุฉ route ุญุฐู ุงููุฏููุนุฉ | 378-417 |
| **app/templates/accounting/payments.html** | ุฒุฑ ุงูุญุฐู + JavaScript | 101-110, 161-175 |
| **app/templates/accounting/payments.html** | ุชุบููุฑ ุงูุนููุฉ | 78 |
| **app/templates/accounting/payment_details.html** | ุชุบููุฑ ุงูุนููุฉ | 40 |

---

## ๐งช ููููุฉ ุงูุงุฎุชุจุงุฑ | How to Test

### **ุงุฎุชุจุงุฑ ุงูุญุฐู:**

**1. ุงูุชุญ ุตูุญุฉ ุงููุฏููุนุงุช:**
```
ุงุฐูุจ ุฅูู: ุงููุญุงุณุจุฉ > ุงููุฏููุนุงุช ูุงูููุจูุถุงุช
```

**2. ุงุฎุชุจุฑ ุญุฐู ููุจูุถุฉ ุจูููุฉ:**
- ุฃูุดุฆ ููุจูุถุฉ ุจูููุฉ ุจูุจูุบ 500โฌ
- ุชุญูู ูู ุฑุตูุฏ ุงูุจูู (ูุฌุจ ุฃู ูุฒูุฏ 500โฌ)
- ุงุถุบุท ุนูู ุฒุฑ ุงูุญุฐู ๐๏ธ ุงูุฃุญูุฑ
- ุฃูุฏ ุงูุญุฐู
- **ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
  - โ ุชู ุญุฐู ุงูููุจูุถุฉ
  - โ ุฑุตูุฏ ุงูุจูู ููุต 500โฌ (ุนูุณ)
  - โ ุฑุณุงูุฉ ูุฌุงุญ

**3. ุงุฎุชุจุฑ ุญุฐู ูุฏููุนุฉ ุจูููุฉ:**
- ุฃูุดุฆ ูุฏููุนุฉ ุจูููุฉ ุจูุจูุบ 300โฌ
- ุชุญูู ูู ุฑุตูุฏ ุงูุจูู (ูุฌุจ ุฃู ูููุต 300โฌ)
- ุงุถุบุท ุนูู ุฒุฑ ุงูุญุฐู ๐๏ธ
- ุฃูุฏ ุงูุญุฐู
- **ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
  - โ ุชู ุญุฐู ุงููุฏููุนุฉ
  - โ ุฑุตูุฏ ุงูุจูู ุฒุงุฏ 300โฌ (ุนูุณ)
  - โ ุฑุณุงูุฉ ูุฌุงุญ

---

### **ุงุฎุชุจุงุฑ ุงูุนููุฉ:**

**1. ุงูุชุญ ุตูุญุฉ ุงููุฏููุนุงุช:**
- ูุฌุจ ุฃู ุชุธูุฑ ุฌููุน ุงููุจุงูุบ ุจู `โฌ` ุจุฏูุงู ูู `ุฑูุงู` โ

**2. ุงูุชุญ ุชูุงุตูู ุฃู ูุฏููุนุฉ:**
- ูุฌุจ ุฃู ูุธูุฑ ุงููุจูุบ ุจู `โฌ` ุจุฏูุงู ูู `ุฑูุงู` โ

---

## ๐ ุฌุฏูู ุงูููุงุฑูุฉ | Comparison Table

| ุงูุนูุตุฑ | ูุจู | ุจุนุฏ |
|--------|-----|-----|
| **ุฒุฑ ุงูุญุฐู** | โ ุบูุฑ ููุฌูุฏ | โ ููุฌูุฏ |
| **ุญุฐู ุงููุฏููุนุฉ** | โ ูุง ูุนูู | โ ูุนูู |
| **ุนูุณ ุงููุนุงููุฉ ุงูุจูููุฉ** | โ ูุง ูุนูู | โ ูุนูู |
| **ุชุฃููุฏ ุงูุญุฐู** | โ ูุง ููุฌุฏ | โ ููุฌุฏ |
| **ุงูุนููุฉ ูู ุงููุงุฆูุฉ** | ุฑูุงู | โฌ |
| **ุงูุนููุฉ ูู ุงูุชูุงุตูู** | ุฑูุงู | โฌ |

---

## ๐ ุงูุตูุงุญูุงุช ุงููุทููุจุฉ | Required Permissions

ูุญุฐู ุงููุฏููุนุงุชุ ูุฌุจ ุฃู ูููู ูุฏู ุงููุณุชุฎุฏู ุงูุตูุงุญูุฉ:
```
accounting.payments.delete
```

---

**ุชุงุฑูุฎ ุงูุฅุตูุงุญ:** 2026-02-13
**ุงูุญุงูุฉ:** โ ุชู ุงูุฅุตูุงุญ ุจูุฌุงุญ

